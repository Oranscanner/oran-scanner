<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1117"/>
<link rel="manifest" href="manifest.json">
<title>Oran's 711s scanner</title>
<style>
  *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
  :root {
    --bg:#0f1117; --surface:#1a1d27; --border:#2e3345;
    --accent:#00e5a0; --accentDim:rgba(0,229,160,0.12);
    --text:#e8eaf0; --muted:#7a7f95; --danger:#ff5c5c;
    --yellow:#ffff00;
  }
  html, body { height: 100%; background:var(--bg); color:var(--text); font-family:'SF Mono',monospace; overflow-x: hidden; }
  body { padding: 10px 15px 160px; scroll-behavior: smooth; } 
  .flash-red { background-color: #660000 !important; }
  .wrap { max-width:680px; margin:0 auto; }
  h1 { font-size: 18px; text-align: center; margin-bottom: 5px; color: var(--accent); }
  .cs-input-wrap { display: flex; align-items: center; justify-content: center; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; }
  .cs-input-wrap span { color: var(--yellow); font-weight: bold; font-size: 22px; margin-right: 5px; }
  .cs-input-wrap input { background: transparent; border: none; color: var(--yellow); width: 120px; outline: none; font-size: 22px; font-weight: bold; text-align: center; }
  .top-stats { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
  .stat-mini { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px; display: flex; justify-content: space-around; align-items: center; }
  .stat-val { font-size: 18px; font-weight: bold; color: var(--accent); }
  .stat-label { font-size: 9px; color: var(--muted); }
  .last-scan-badge { display: flex; gap: 8px; margin-bottom: 10px; }
  .badge-item { flex: 1; background: var(--accentDim); border: 1px solid var(--accent); padding: 8px; border-radius: 8px; text-align: center; }
  .badge-label { font-size: 8px; color: var(--accent); text-transform: uppercase; }
  .badge-val { font-size: 14px; font-weight: bold; }
  .card-tight { background:var(--surface); border-radius:10px; border:1px solid var(--border); padding:8px; margin-bottom:10px; }
  #interactive.viewport { width: 100%; max-width: 260px; margin: 0 auto 8px; aspect-ratio: 1/1; border-radius:8px; overflow:hidden; border:1px solid var(--border); position:relative; background: #000; }
  #interactive video { width: 100%; height: 100%; object-fit: cover; }
  .tbl-body { display:flex; flex-direction:column; gap:4px; margin-bottom: 20px; }
  .tbl-row { display:grid; grid-template-columns:30px 1fr 1.5fr 30px; gap:4px; align-items:center; padding:4px; border-radius:6px; background:rgba(255,255,255,0.03); }
  .tbl-row input { background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:8px; color:white; font-size: 14px; width:100%; }
  .editable-serial { color: var(--accent); font-weight: bold; border: 1px solid var(--border) !important; }
  .invalid-field { border-color: var(--danger) !important; color: var(--danger) !important; }
  .btn { border-radius:8px; font-weight:600; cursor:pointer; border:none; display:flex; align-items:center; justify-content:center; }
  .btn-cam { padding:10px; width:100%; margin-bottom:8px; background:var(--accentDim); color:var(--accent); border:1px solid var(--accent); }
  .btn-clear-mini { background: var(--danger); color: white; padding: 10px; flex: 1; font-size: 12px; }
  .actions-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); padding: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border); z-index: 100; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
  .btn-export { background:var(--accent); color:var(--bg); padding:15px; flex:1.5; }
  .btn-copy { background:var(--surface); border:1px solid var(--border); color:white; flex:1; }
  .jump-btn { position: fixed; bottom: 180px; right: 20px; width: 50px; height: 50px; background: var(--accent); color: var(--bg); border-radius: 50%; display: flex; z-index: 999; box-shadow: 0 4px 15px rgba(0,0,0,0.6); font-size: 24px; align-items:center; justify-content:center; border: 2px solid var(--bg); }
  #msg { text-align: center; font-size: 11px; color: var(--danger); font-weight: bold; height: 15px; margin-bottom: 5px; }
</style>
</head>
<body id="mainBody">
<div class="wrap">
  <h1>Oran's 711s scanner</h1>
  <div class="cs-input-wrap"><span>#</span><input type="tel" id="csInput" maxlength="5" oninput="saveCS()"></div>
  <div class="last-scan-badge">
    <div class="badge-item"><div class="badge-label">Zone</div><div id="lastZoneVal" class="badge-val">---</div></div>
    <div class="badge-item"><div class="badge-label">Serial</div><div id="lastSerialVal" class="badge-val">----------</div></div>
  </div>
  <div class="top-stats">
    <div class="stat-mini"><span class="stat-label">UNIQUE:</span><span id="statFilled" class="stat-val">0</span></div>
    <button class="btn btn-clear-mini" onclick="clearAll()">Clear All</button>
  </div>
  <div class="card-tight">
    <div id="msg"></div>
    <div id="interactive" class="viewport" style="display:none;"></div>
    <button class="btn btn-cam" id="camBtn">â–¶ START CAMERA</button>
    <div style="display:flex; gap:6px;">
        <input type="tel" id="manualInput" placeholder="10-digit..." maxlength="10" style="flex:1; background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:8px; color:white;">
        <button id="addBtn" class="btn" style="background:var(--accent); color:var(--bg); padding:0 12px; font-size: 12px;">ADD</button>
    </div>
  </div>
  <div class="tbl-body" id="tableBody"></div>
  <div class="actions-fixed">
    <button class="btn btn-export" id="exportBtn">EXPORT EXCEL</button>
    <button class="btn btn-copy" id="copyBtn">Copy</button>
  </div>
  <button class="btn jump-btn" id="jumpBtn" onclick="window.scrollTo(0,0)">â†‘</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/oran-scanner/service-worker.js', { scope: '/oran-scanner/' });
}
const TOTAL = 65; 
let rows = JSON.parse(localStorage.getItem('scannerRows')) || Array.from({length:TOTAL}, () => ({zone:'', serial:''}));
let isScanning = false;
let lastScannedTime = 0;

document.getElementById('csInput').value = localStorage.getItem('csNumber') || '';
function saveCS() { localStorage.setItem('csNumber', document.getElementById('csInput').value); }

function triggerErrorVisual(customMsg) {
    if(customMsg) document.getElementById('msg').innerText = customMsg;
    document.getElementById('mainBody').classList.add('flash-red');
    setTimeout(() => { 
        document.getElementById('mainBody').classList.remove('flash-red');
        if(customMsg) setTimeout(() => document.getElementById('msg').innerText = "", 2000);
    }, 250);
}

function playSound(type) {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const gain = audioCtx.createGain();
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        const osc = audioCtx.createOscillator();
        osc.connect(gain);
        if(type === 'success') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        } else {
            osc.type = 'square'; osc.frequency.setValueAtTime(220, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        }
    } catch(e) {}
}

function handleData(code) {
    const msg = document.getElementById('msg');
    const now = Date.now();
    if (now - lastScannedTime < 2000) return; 
    if (code.length !== 10) { triggerErrorVisual("âš ï¸ INVALID"); playSound('error'); return; }
    if (rows.some(r => r.serial === code)) { triggerErrorVisual("âŒ DUPLICATE"); playSound('error'); lastScannedTime = now; return; }

    const idx = rows.findIndex(r => !r.serial);
    if (idx !== -1) {
        msg.innerText = "";
        rows[idx].serial = code;
        document.getElementById('lastZoneVal').innerText = rows[idx].zone || "N/A";
        document.getElementById('lastSerialVal').innerText = code;
        playSound('success');
        if (navigator.vibrate) navigator.vibrate(50);
        lastScannedTime = now; 
        renderTable();
    }
}

async function startScanner() {
    document.getElementById('interactive').style.display = 'block';
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');
    const selectedId = videoDevices[videoDevices.length - 1].deviceId;
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: "#interactive", constraints: { deviceId: selectedId ? { exact: selectedId } : undefined, facingMode: "environment", width: 800, height: 800 }},
        decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader", "code_39_reader"] }
    }, (err) => {
        if (!err) {
            Quagga.start(); isScanning = true;
            document.getElementById('camBtn').innerText = "â¹ STOP";
            const track = Quagga.CameraAccess.getActiveTrack();
            if (track && track.getCapabilities().zoom) track.applyConstraints({ advanced: [{ zoom: 2.5 }] });
        }
    });
}

Quagga.onDetected((data) => handleData(data.codeResult.code));

function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    rows.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'tbl-row';
        const isInvalid = r.serial.length > 0 && r.serial.length !== 10;
        div.innerHTML = `
            <span style="font-size:9px; color:var(--muted)">${i+1}</span>
            <input type="tel" id="zone-${i}" maxlength="3" value="${r.zone}" oninput="handleZoneInput(${i}, this.value)">
            <input type="tel" id="ser-${i}" maxlength="10" 
              class="editable-serial ${isInvalid ? 'invalid-field' : ''}" 
              value="${r.serial}" 
              oninput="handleSerialInput(${i}, this.value)" 
              onblur="finalCheck(${i}, this.value)">
            <button onclick="rows[${i}].serial=''; renderTable();" style="background:none; border:none; color:var(--danger); cursor:pointer;">Ã—</button>
        `;
        tbody.appendChild(div);
    });
    document.getElementById('statFilled').innerText = rows.filter(r => r.serial && r.serial.trim().length === 10).length;
    localStorage.setItem('scannerRows', JSON.stringify(rows));
}

function finalCheck(idx, val) {
    if (val.length > 0 && val.length !== 10) {
        triggerErrorVisual("âš ï¸ 10 DIGITS REQUIRED");
        playSound('error');
    }
}

function handleZoneInput(idx, val) {
    rows[idx].zone = val;
    localStorage.setItem('scannerRows', JSON.stringify(rows));
    if (val.length >= 3 && idx + 1 < TOTAL) document.getElementById(`zone-${idx+1}`).focus();
}

function handleSerialInput(idx, val) {
    rows[idx].serial = val;
    localStorage.setItem('scannerRows', JSON.stringify(rows));
    // Quietly update the counter without redrawing the whole table
    document.getElementById('statFilled').innerText = rows.filter(r => r.serial && r.serial.trim().length === 10).length;
}

function clearAll() { 
    if(confirm("Wipe everything?")){ 
        rows=Array.from({length:TOTAL},()=>({zone:'',serial:''})); 
        document.getElementById('csInput').value = '';
        localStorage.clear();
        renderTable(); 
    }
}

document.getElementById('camBtn').addEventListener('click', () => isScanning ? location.reload() : startScanner());
document.getElementById('addBtn').addEventListener('click', () => {
    handleData(document.getElementById('manualInput').value);
    document.getElementById('manualInput').value = '';
});

document.getElementById('exportBtn').addEventListener('click', () => {
    const cs = document.getElementById('csInput').value;
    if (cs.length !== 5) { alert("5-digit CS required"); return; }
    const activeData = rows.filter(r => r.serial);
    if (activeData.some(r => r.serial.length !== 10)) { 
        triggerErrorVisual("ðŸ›‘ FIX RED SERIALS FIRST");
        return; 
    }
    const dataWithCS = [["System CS#:", cs], ["Zone", "Serial Number"], ...activeData.map(r => [r.zone, r.serial])];
    const ws = XLSX.utils.aoa_to_sheet(dataWithCS);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, `${cs}.xlsx`);
});

document.getElementById('copyBtn').addEventListener('click', () => {
    const cs = document.getElementById('csInput').value;
    const dataRows = rows.filter(r => r.serial).map(r => `${r.zone}\t${r.serial}`).join('\n');
    navigator.clipboard.writeText(`CS#: ${cs}\n${dataRows}`);
    alert("Copied!");
});
renderTable();
</script>
</body>
</html>
