<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1117"/>
<link rel="manifest" href="manifest.json">
<title>oranSCAN-711s</title>
<style>
  *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
  :root {
    --bg:#0f1117; --surface:#1a1d27; --border:#2e3345;
    --accent:#00e5a0; --accentDim:rgba(0,229,160,0.12);
    --text:#e8eaf0; --muted:#7a7f95; --danger:#ff5c5c;
    --yellow:#ffff00;
    --brandBlue: #3a86ff;
    --camBg: #add8e6; 
    --camText: #00008b;
  }
  
  html, body { height: 100%; background:var(--bg); color:var(--text); font-family:'SF Mono',monospace; overflow: hidden; position: fixed; width: 100%; }
  .main-container { height: 100vh; display: flex; flex-direction: column; }
  
  .sticky-top { padding: 10px 15px 5px; background: var(--bg); z-index: 20; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  
  /* Increased padding-bottom to 400px to ensure we can always scroll rows to the top */
  .scroll-area { flex: 1; overflow-y: auto; padding: 10px 15px 400px; -webkit-overflow-scrolling: touch; }

  .flash-red { background-color: #660000 !important; }
  .wrap { max-width:680px; margin:0 auto; }
  h1 { font-size: 18px; text-align: center; margin-bottom: 5px; color: var(--brandBlue); font-weight: 800; }
  
  .cs-input-wrap { display: flex; align-items: center; justify-content: center; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; }
  .cs-input-wrap span { color: var(--yellow); font-weight: bold; font-size: 22px; margin-right: 5px; }
  .cs-input-wrap input { background: transparent; border: none; color: var(--yellow); width: 120px; outline: none; font-size: 22px; font-weight: bold; text-align: center; }
  
  .top-stats { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
  .stat-mini { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px; display: flex; justify-content: center; align-items: center; gap: 8px; }
  .stat-val { font-size: 18px; font-weight: bold; color: var(--accent); }

  .last-scan-badge { display: flex; gap: 8px; margin-bottom: 10px; }
  .badge-item { flex: 1; background: var(--accentDim); border: 1px solid var(--accent); padding: 8px; border-radius: 8px; text-align: center; }
  .badge-label { font-size: 8px; color: var(--accent); text-transform: uppercase; }
  .badge-val { font-size: 14px; font-weight: bold; }
  
  .card-tight { background:var(--surface); border-radius:10px; border:1px solid var(--border); padding:8px; margin-bottom:10px; }
  #interactive.viewport { width: 100%; max-width: 240px; margin: 0 auto 8px; aspect-ratio: 1/1; border-radius:8px; overflow:hidden; border:1px solid var(--border); position:relative; background: #000; }
  #interactive video { width: 100%; height: 100%; object-fit: cover; }
  
  .tbl-body { display:flex; flex-direction:column; gap:6px; margin-bottom: 20px; }
  .tbl-row { display:grid; grid-template-columns:30px 1fr 1.5fr 30px; gap:6px; align-items:center; padding:6px; border-radius:6px; background:rgba(255,255,255,0.03); }
  .tbl-row input { background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:12px; color:white; font-size: 16px; width:100%; outline: none; -webkit-appearance: none; }

  .box-complete { background: #ffffff !important; color: #000000 !important; border: 1px solid #cccccc !important; font-weight: bold; }
  .invalid-field { border: 2px solid var(--danger) !important; background: #300 !important; }
  
  .btn { border-radius:8px; font-weight:600; cursor:pointer; border:none; display:flex; align-items:center; justify-content:center; }
  .btn-cam { padding:10px; width:100%; margin-bottom:8px; background:var(--camBg); color:var(--camText); border:1px solid var(--brandBlue); }
  .btn-clear-mini { background: var(--danger); color: white; padding: 10px; flex: 0.5; font-size: 12px; }
  
  .actions-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); padding: 15px; display: flex; gap: 10px; border-top: 1px solid var(--border); z-index: 100; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
  .btn-export { background:var(--accent); color:var(--bg); padding:15px; flex:1.5; }
  .btn-copy { background:var(--surface); border:1px solid var(--border); color:white; flex:1; }
  
  .jump-btn { position: fixed; bottom: 180px; right: 20px; width: 50px; height: 50px; background: var(--brandBlue); color: white; border-radius: 50%; display: none; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.6); font-size: 24px; align-items:center; justify-content:center; border: 2px solid var(--bg); }
  #msg { text-align: center; font-size: 11px; color: var(--danger); font-weight: bold; height: 15px; margin-bottom: 5px; }
</style>
</head>
<body id="mainBody">

<div class="main-container">
  <div class="sticky-top" id="topSection">
    <div class="wrap">
      <h1>oranSCAN-711s</h1>
      <div class="cs-input-wrap"><span>#</span><input type="tel" id="csInput" maxlength="5" placeholder="CS#" oninput="saveCS()"></div>
      <div class="last-scan-badge">
        <div class="badge-item"><div class="badge-label">Zone</div><div id="lastZoneVal" class="badge-val">---</div></div>
        <div class="badge-item"><div class="badge-label">Serial</div><div id="lastSerialVal" class="badge-val">----------</div></div>
      </div>
      <div class="top-stats">
        <div class="stat-mini"><span id="statFilled" class="stat-val">0</span><span class="stat-label">Units Scanned</span></div>
        <button class="btn btn-clear-mini" onclick="clearAll()">Clear All</button>
      </div>
      <div class="card-tight">
        <div id="msg"></div>
        <div id="interactive" class="viewport" style="display:none;"></div>
        <button class="btn btn-cam" id="camBtn">▶ START SCANNER</button>
        <div style="display:flex; gap:6px;">
            <input type="tel" id="manualInput" placeholder="Enter 10-digit serial..." onfocus="syncManualBadge()" oninput="checkManualLength(this)" style="flex:1; background:var(--bg); border:1px solid var(--border); border-radius:6px; padding:10px; color:white;">
            <button id="addBtn" class="btn" style="background:var(--accent); color:var(--bg); padding:0 12px; font-size: 12px;">ADD</button>
        </div>
      </div>
    </div>
  </div>

  <div class="scroll-area" id="scrollArea" onscroll="handleScroll()">
    <div class="wrap">
      <div class="tbl-body" id="tableBody"></div>
    </div>
  </div>

  <div class="actions-fixed" id="footerActions">
    <button class="btn btn-export" id="exportBtn">EXPORT EXCEL</button>
    <button class="btn btn-copy" id="copyBtn">Copy</button>
  </div>
  <button class="btn jump-btn" id="jumpBtn" onclick="document.getElementById('scrollArea').scrollTo(0,0)">↑</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const TOTAL = 65; 
let rows = JSON.parse(localStorage.getItem('scannerRows')) || Array.from({length:TOTAL}, () => ({zone:'', serial:''}));
let isScanning = false;
let lastScannedTime = 0;

document.getElementById('csInput').value = localStorage.getItem('csNumber') || '';
function saveCS() { localStorage.setItem('csNumber', document.getElementById('csInput').value); }

function handleScroll() {
    const jumpBtn = document.getElementById('jumpBtn');
    const scrollArea = document.getElementById('scrollArea');
    jumpBtn.style.display = scrollArea.scrollTop > 300 ? 'flex' : 'none';
}

function syncManualBadge() {
    const idx = rows.findIndex(r => !r.serial);
    if (idx !== -1) {
        document.getElementById('lastZoneVal').innerText = rows[idx].zone || "---";
        document.getElementById('lastSerialVal').innerText = "----------";
    }
}

function checkManualLength(el) {
    if (el.value.length > 10) {
        triggerErrorVisual("⚠️ MAX 10 DIGITS");
        playSound('error');
        el.value = el.value.slice(0, 10);
    }
}

function triggerErrorVisual(customMsg) {
    if(customMsg) document.getElementById('msg').innerText = customMsg;
    document.getElementById('mainBody').classList.add('flash-red');
    setTimeout(() => { 
        document.getElementById('mainBody').classList.remove('flash-red');
        if(customMsg) setTimeout(() => document.getElementById('msg').innerText = "", 2000);
    }, 250);
}

function playSound(type) {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if(type === 'success') {
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    } catch(e) {}
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    rows.forEach((r, i) => {
        const div = document.createElement('div');
        div.className = 'tbl-row';
        div.id = `row-${i}`;
        div.innerHTML = `
            <span style="font-size:9px; color:var(--muted)">${i+1}</span>
            <input type="tel" id="zone-${i}" maxlength="3" 
              class="${r.zone.length === 3 ? 'box-complete' : ''}" 
              value="${r.zone}" oninput="handleZoneInput(${i}, this)">
            <input type="tel" id="ser-${i}" maxlength="10" 
              class="${r.serial.length === 10 ? 'box-complete' : ''}" 
              value="${r.serial}" oninput="handleSerialInput(${i}, this)">
            <button onclick="clearRow(${i})" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:20px;">×</button>
        `;
        tbody.appendChild(div);
    });
    updateUniqueCount();
}

function handleZoneInput(idx, el) {
    const val = el.value;
    el.classList.remove('invalid-field', 'box-complete');

    if (val.length === 3 && rows.some((r, i) => r.zone === val && i !== idx)) {
        triggerErrorVisual("❌ DUPLICATE ZONE");
        playSound('error');
        el.classList.add('invalid-field');
        return;
    }

    rows[idx].zone = val;
    localStorage.setItem('scannerRows', JSON.stringify(rows));

    if (val.length === 3) {
        el.classList.add('box-complete');
        const nextIdx = idx + 1;
        if(nextIdx < TOTAL) {
            // Instant jump to avoid keyboard sync issues
            setTimeout(() => {
                const nextInput = document.getElementById(`zone-${nextIdx}`);
                const nextRow = document.getElementById(`row-${nextIdx}`);
                const scrollArea = document.getElementById('scrollArea');
                
                if(nextInput) nextInput.focus();
                if(nextRow && scrollArea) {
                    // Force the new row to the VERY TOP of the scroll area
                    const scrollPos = nextRow.offsetTop - scrollArea.offsetTop;
                    scrollArea.scrollTo({ top: scrollPos, behavior: 'auto' });
                }
            }, 10);
        }
    }
}

function handleSerialInput(idx, el) {
    const val = el.value;
    el.classList.remove('invalid-field', 'box-complete');

    if (val.length === 10 && rows.some((r, i) => r.serial === val && i !== idx)) {
        triggerErrorVisual("❌ DUPLICATE SERIAL");
        playSound('error');
        el.classList.add('invalid-field');
        return;
    }

    rows[idx].serial = val;
    localStorage.setItem('scannerRows', JSON.stringify(rows));
    if (val.length === 10) el.classList.add('box-complete');
    updateUniqueCount();
}

function clearRow(i) {
    rows[i].serial = '';
    rows[i].zone = '';
    renderTable();
}

function updateUniqueCount() {
    document.getElementById('statFilled').innerText = rows.filter(r => r.serial.length === 10).length;
}

function clearAll() { 
    if(confirm("Wipe everything?")){ 
        rows=Array.from({length:TOTAL},()=>({zone:'',serial:''})); 
        localStorage.clear(); renderTable(); 
    }
}

function handleData(code) {
    const now = Date.now();
    if (now - lastScannedTime < 2000) return; 
    if (code.length !== 10) { triggerErrorVisual("⚠️ INVALID"); playSound('error'); return; }
    if (rows.some(r => r.serial === code)) { triggerErrorVisual("❌ DUPLICATE SERIAL"); playSound('error'); return; }

    const idx = rows.findIndex(r => !r.serial);
    if (idx !== -1) {
        rows[idx].serial = code;
        document.getElementById('lastZoneVal').innerText = rows[idx].zone || "N/A";
        document.getElementById('lastSerialVal').innerText = code;
        playSound('success');
        lastScannedTime = now; 
        renderTable();
        // Scroll the filled row into view
        const targetRow = document.getElementById(`row-${idx}`);
        if(targetRow) targetRow.scrollIntoView({behavior:'smooth', block:'center'});
    }
}

async function startScanner() {
    document.getElementById('interactive').style.display = 'block';
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');
    const selectedId = videoDevices[videoDevices.length - 1].deviceId;
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: "#interactive", constraints: { deviceId: selectedId ? { exact: selectedId } : undefined, facingMode: "environment", width: 800, height: 800 }},
        decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader", "code_39_reader"] }
    }, (err) => {
        if (!err) {
            Quagga.start(); isScanning = true;
            document.getElementById('camBtn').innerText = "⏹ STOP SCANNER";
        }
    });
}

Quagga.onDetected((data) => handleData(data.codeResult.code));
document.getElementById('camBtn').addEventListener('click', () => isScanning ? location.reload() : startScanner());
document.getElementById('addBtn').addEventListener('click', () => {
    handleData(document.getElementById('manualInput').value);
    document.getElementById('manualInput').value = '';
});

document.getElementById('exportBtn').addEventListener('click', () => {
    const cs = document.getElementById('csInput').value;
    if (cs.length !== 5) return alert("5-digit CS required");
    const activeData = rows.filter(r => r.zone.trim().length > 0);
    const dataWithCS = [["System CS#:", cs], ["Zone", "Serial"], ...activeData.map(r => [r.zone, r.serial])];
    const ws = XLSX.utils.aoa_to_sheet(dataWithCS);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, `${cs}.xlsx`);
});

document.getElementById('copyBtn').addEventListener('click', () => {
    const cs = document.getElementById('csInput').value;
    const dataRows = rows.filter(r => r.zone.trim().length > 0).map(r => `${r.zone}\t${r.serial}`).join('\n');
    navigator.clipboard.writeText(`CS#: ${cs}\n${dataRows}`);
    alert("Copied!");
});

renderTable();
</script>
</body>
</html>
